#  create-rootfs.yml
#  Created: 2024/09/15 - 08:10
#  Altered: qua 18 fev 2026 13:05:00 -04
#  Version: 1.3.6
#
#  Copyright (c) 2024-2026, Vilmar Catafesta <vcatafesta@gmail.com>
#  All rights reserved.
##############################################################################
name: Build ROOTFS VoidBR

on:
  push:
    branches:
      - main
  repository_dispatch:
    types:
      - "ISO-*"
  workflow_dispatch:
    inputs:
      name:
        type: string
        description: "Name for the ISO"
        required: true
        default: "voidlinux"
      edition:
        type: choice
        description: "Edition"
        options:
          - base-minimal
          - base-system
          - base-voidstrap
          - base-custom
        default: "base-custom"
      tmate:
        type: boolean
        description: "Enable debugging with tmate"
        required: false
        default: false

  schedule:
    - cron: "0 7 * * *"

env:
  TELEGRAM_TOKEN: "${{ secrets.TOKEN_BOT }}"
  GITHUB_TOKEN: "${{ secrets.ORGANIZATION_TOKEN }}"
  CHAT_ID: "${{ secrets.CHAT_ID }}"
  MESSAGE_THREAD_ID: "${{ secrets.MESSAGE_THREAD_ID }}"
  started_by_user: "${{ github.actor }}"
  triggered_by_user: "${{ github.triggering_actor }}"
  iso_distroname: "${{ github.event.client_payload.distroname || inputs.distroname || 'voidBR' }}"
  edition: "${{ github.event.client_payload.edition || inputs.edition || 'custom' }}"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      time: ${{ steps.time.outputs.time }}
    steps:
      - name: Obter a hora atual
        id: time
        run: echo "time=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Enviar notifica√ß√£o para o Telegram
        shell: bash
        run: |
          link_action=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
          MESSAGE="üöÄ <b>[step 1/3] build-rootfs-void - INICIANDO WORKFLOW</b>
          <b>Job:</b> <code>#${GITHUB_RUN_NUMBER}</code>
          <b>Job URL:</b> <a href='${link_action}'>${link_action}</a>
          <b>Workflow:</b> <code>build-rootfs-void/create-rootfs.yml</code>
          <b>Iniciado/Triggered:</b> <code>${started_by_user}/${triggered_by_user}</code>
          <b>Distroname:</b> <code>${iso_distroname}</code>
          <b>Edition:</b> <code>${edition}</code>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d message_thread_id="${MESSAGE_THREAD_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML"

  build:
    name: Build void-x86_64-${{ github.event.client_payload.edition || 'base-custom' }}
    runs-on: ubuntu-latest
    needs: [setup]
    container:
      image: vcatafesta/voidlinux-docker:1.5
      options: --privileged

    steps:
      - name: Capturar hora de in√≠cio real
        run: |
          echo "S_TIME_HUMAN=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "S_TIMESTAMP=$(date +%s)" >> $GITHUB_ENV

      - name: Install Required Libraries
        run: |
          xbps-install -Syu xbps
          xbps-install -Syu xtools bash sudo openssh tmate xz zip kmod ncurses which vpm libstdc++ nano curl git tree duf

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Build ROOTFS Void
        uses: ./
        id: build
        with:
          name: ${{ github.event.client_payload.name || inputs.name }}
          tmate: ${{ github.event.client_payload.tmate || 'false' }}
          github_token: ${{ secrets.ORGANIZATION_TOKEN }}
          message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}

      - name: Calculate MD5 Hash
        shell: bash
        run: |
          pushd "${{ env.WORK_PATH }}"
          md5sum "${{ env.XZ_BASENAME }}" > "${{ env.XZ_BASENAME }}.md5"
          popd

      - name: Prepare ZIP file for release
        shell: bash
        run: |
          release="${XZ_BASENAME%.tar.xz}"
          zip --junk-paths --store -s 2000m "${{ env.WORK_PATH }}/${release}.zip" "${{ env.XZ_FULLNAME }}" "${{ env.XZ_FULLNAME }}.md5"
          echo "ZIP_FULLNAME=${{ env.WORK_PATH }}/${release}.zip" >> $GITHUB_ENV
          echo "ZIP_BASENAME=${release}.zip" >> $GITHUB_ENV

      - name: Criar release .tar.xz
        id: create_release_xz
        uses: actions/create_release@v1
        with:
          tag_name: ${{ env.XZ_TAG_NAME }}
          release_name: Release ${{ env.XZ_TAG_NAME }}
          body: "Auto-generated build"
          draft: false
          prerelease: false

      - name: Fazer upload do arquivo .tar.xz no release
        id: upload-xz
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release_xz.outputs.upload_url }}
          asset_path: ${{ env.XZ_FULLNAME }}
          asset_name: ${{ env.XZ_BASENAME }}
          asset_content_type: application/x-xz

      - name: Atualizar reposit√≥rio void-install
        shell: bash
        run: |
          git clone --depth=1 https://x-access-token:${{ secrets.ORGANIZATION_TOKEN }}@github.com/voidlinuxbr/void-install.git "${{ env.WORK_PATH }}/void-install"
          cd "${{ env.WORK_PATH }}/void-install"
          cp -fv "${{ env.XZ_FULLNAME }}" void-x86_64-base-custom-current.tar.xz
          cp -fv "${{ env.XZ_FULLNAME }}.md5" void-x86_64-base-custom-current.tar.xz.md5
          sed -i "s/${{ env.XZ_BASENAME }}/void-x86_64-base-custom-current.tar.xz/g" void-x86_64-base-custom-current.tar.xz.md5
          git config --global user.email "vctafesta@gmail.com"
          git config --global user.name "GitHub Actions"
          git add .
          git commit -m "Auto Update ROOTFS"
          git push origin main

      - name: Enviar notifica√ß√£o final para o Telegram
        if: always()
        shell: bash
        env:
          D_URL: ${{ steps.upload-xz.outputs.browser_download_url }}
          START_T: ${{ env.S_TIME_HUMAN }}
          START_TS: ${{ env.S_TIMESTAMP }}
        run: |
          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))
          MIN=$((DURATION / 60))
          SEC=$((DURATION % 60))
          
          FILE_SIZE="N/A"
          if [[ -f "${{ env.XZ_FULLNAME }}" ]]; then
            FILE_SIZE=$(du -h "${{ env.XZ_FULLNAME }}" | cut -f1)
          fi
          
          STATUS="${{ job.status }}"
          if [[ "$STATUS" == "success" ]]; then
            EMOJI="‚úÖ"
            TEXT_STATUS="CONCLU√çDO COM SUCESSO"
            DOWNLOAD_LINK="<a href='${D_URL}'>Direto .tar.xz</a>"
          else
            EMOJI="‚ùå"
            TEXT_STATUS="FALHOU"
            DOWNLOAD_LINK="N/A"
          fi
          
          link_action=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}
          
          MESSAGE="${EMOJI} <b>[step 3/3] build-rootfs-void - ${TEXT_STATUS}</b>
          <b>Job        :</b> <code>#${GITHUB_RUN_NUMBER}</code>
          <b>Job URL    :</b> <a href='${link_action}'>${link_action}</a>
          <b>Edition    :</b> <code>${edition}</code>
          <b>Inicio     :</b> <code>${START_T}</code>
          <b>Dura√ß√£o    :</b> <code>${MIN}m ${SEC}s</code>
          <b>Status     :</b> <code>${STATUS}</code>
          <b>Download   :</b> ${DOWNLOAD_LINK}
          <b>Tamanho    :</b> <code>${FILE_SIZE}</code>
          <b>URL        :</b> <a href='${link_action}'>Ver Detalhes</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d message_thread_id="${MESSAGE_THREAD_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML"
