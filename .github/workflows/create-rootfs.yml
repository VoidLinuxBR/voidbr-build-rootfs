#  create-rootfs.yml
#  Created: 2024/09/15 - 08:10
#  Altered: qua 20 nov 2024 10:00:22 -04
#
#  Copyright (c) 2024-2024, Vilmar Catafesta <vcatafesta@gmail.com>
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#  1. Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#  2. Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
#
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
#  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
#  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
##############################################################################
name: Build ROOTFS VoidBR

# Gatilhos para o workflow
on:
  push:
    branches:
      - main
  repository_dispatch:
    types:
      - "ISO-*"
  workflow_dispatch:
    inputs:
      name:
        type: string
        description: "Name for the ISO"
        required: true
        default: "voidlinux"
      edition:
        type: choice
        description: "Edition"
        options:
          - base-minimal
          - base-system
          - base-voidstrap
          - base-custom
        default: "base-custom"
      tmate:
        type: boolean
        description: "Enable debugging with tmate"
        required: false
        default: false

  schedule:
    - cron: "0 22 * * 5"

env:
  TELEGRAM_TOKEN: "${{ secrets.TOKEN_BOT }}"
  GITHUB_TOKEN: "${{ secrets.ORGANIZATION_TOKEN }}"
  CHAT_ID: "${{ secrets.CHAT_ID }}"
  MESSAGE_THREAD_ID: "${{ secrets.MESSAGE_THREAD_ID }}"
  started_by_user: "${{ github.actor }}"
  triggered_by_user: "${{ github.triggering_actor }}"
  DEBUG: "${{ github.event.client_payload.tmate || inputs.tmate || false }}"
  tmate: "${{ github.event.client_payload.tmate || inputs.tmate || false }}"
  iso_distroname: "${{ github.event.client_payload.distroname || inputs.distroname || 'voidBR' }}"
  edition: "${{ github.event.client_payload.edition || inputs.edition || 'custom' }}"

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      time: ${{ steps.time.outputs.time }}
      REPOSITORY_NAME: ${{ steps.get-repo-name.outputs.repo_name }}
    steps:
      - name: Obter a hora atual
        id: time
        run: |
          echo "time=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Capturar hora de in√≠cio do workflow
        id: start-time
        shell: bash
        run: |
          START_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          START_TIMESTAMP=$(date +%s)
          echo "START_TIME=$START_TIME" >> $GITHUB_ENV
          echo "START_TIMESTAMP=$START_TIMESTAMP" >> $GITHUB_ENV

      - name: Obter nome do reposit√≥rio
        id: get-repo-name
        run: echo "repo_name=$(basename "$GITHUB_REPOSITORY")" >> "$GITHUB_OUTPUT"

      - name: Enviar notifica√ß√£o para o Telegram
        shell: bash
        run: |
          link_action=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

          MESSAGE="üöÄ <b>[step 1/3] build-rootfs-void - INICIANDO WORKFLOW</b>
          <b>Job:</b> <code>#${GITHUB_RUN_NUMBER}</code>
          <b>Job URL:</b> <a href='${link_action}'>${link_action}</a>
          <b>Workflow:</b> <code>build-rootfs-void/create-rootfs.yml</code>
          <b>Iniciado/Triggered:</b> <code>${started_by_user}/${triggered_by_user}</code>
          <b>Inicio:</b> <code>${START_TIME}</code>
          <b>Distroname:</b> <code>${iso_distroname}</code>
          <b>Edition:</b> <code>${edition}</code>
          <b>Tmate:</b> <code>${DEBUG}</code>"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d message_thread_id="${MESSAGE_THREAD_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="HTML"

  build:
    name: Build void-x86_64-${{ github.event.client_payload.edition || 'base-custom' }}
    runs-on: ubuntu-latest
    needs: [setup]

    env:
      REPO_NAME: ${{ needs.setup.outputs.REPOSITORY_NAME }}

    container:
      image: vcatafesta/voidlinux-docker:1.5
      options: --privileged

    steps:

      - name: Install Required Libraries
        run: |
          xbps-install -Syu xbps
          xbps-install -Syu xtools bash sudo openssh tmate xz zip kmod ncurses which vpm libstdc++ nano curl git bash tree duf

      - name: Create user builduser
        run: |
          useradd -m -G wheel,audio,video,cdrom,optical,kvm,xbuilder builduser || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build ROOTFS Void
        uses: ./
        id: build
        with:
          name: ${{ github.event.client_payload.name || inputs.name }}
          tmate: ${{ github.event.client_payload.tmate || 'false' }}
          github_token: ${{ secrets.ORGANIZATION_TOKEN }}
          message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}

    - name: Clonar reposit√≥rio de destino https://github.com/voidlinuxbr/void-install.git
      shell: bash
      run: |
        pushd "${{ env.WORK_PATH }}"
        git clone --depth=1 https://x-access-token:${{ secrets.ORGANIZATION_TOKEN }}@github.com/voidlinuxbr/void-install.git
        popd

      - name: Empurrar mudan√ßas para o reposit√≥rio de destino
        shell: bash
        run: |
          pushd "${{ env.WORK_PATH }}/void-install"
          git push origin main
          popd
